{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WeatherVista - Interactive Weather Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4cc9f0;
      --dark-color: #1a1a2e;
      --light-color: #f8f9fa;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #f44336;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: var(--light-color);
      overflow: hidden;
    }
    
    #map {
      height: 100vh;
      width: 100%;
      z-index: 1;
    }
    
    /* Floating Control Panel */
    .map-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .map-button {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.18);
      padding: 12px 18px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 180px;
      justify-content: center;
    }
    
    .map-button:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
    }
    
    .map-button i {
      font-size: 16px;
    }
    
    /* Weather Info Panel */
    .weather-info-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 16px;
      width: 300px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.4s ease;
    }
    
    .weather-info-panel.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .weather-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .weather-location {
      font-size: 18px;
      font-weight: 600;
    }
    
    .weather-temp {
      font-size: 36px;
      font-weight: 700;
      margin: 8px 0;
    }
    
    .weather-desc {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .weather-icon {
      width: 40px;
      height: 40px;
    }
    
    .weather-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .detail-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }
    
    /* Custom Popup Styling */
    .leaflet-popup-content-wrapper {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      color: white;
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .leaflet-popup-content {
      margin: 0;
      padding: 16px;
    }
    
    .leaflet-popup-tip {
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Animated Background Elements */
    .floating-elements {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    
    .floating-element {
      position: absolute;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 50%;
      animation: float 15s infinite linear;
    }
    
    @keyframes float {
      0% { transform: translateY(0) rotate(0deg); }
      100% { transform: translateY(-1000px) rotate(720deg); }
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .map-controls {
        top: 10px;
        right: 10px;
      }
      
      .map-button {
        padding: 10px 12px;
        min-width: auto;
      }
      
      .weather-info-panel {
        width: calc(100% - 40px);
        bottom: 10px;
        left: 20px;
      }
    }
  </style>
</head>
<body>

<!-- Animated Background Elements -->
<div class="floating-elements">
  <div class="floating-element" style="width: 100px; height: 100px; top: 20%; left: 10%; animation-delay: 0s;"></div>
  <div class="floating-element" style="width: 150px; height: 150px; top: 60%; left: 70%; animation-delay: -3s;"></div>
  <div class="floating-element" style="width: 200px; height: 200px; top: 30%; left: 50%; animation-delay: -5s;"></div>
</div>

<!-- Map Container -->
<div id="map"></div>

<!-- Map Controls -->
<div class="map-controls">
  <button class="map-button" data-weather-url="{% url 'index' %}" onclick="window.location.href=this.getAttribute('data-weather-url')">
    <i class="bi bi-arrow-left"></i> Back to Weather
  </button>
  <button class="map-button" onclick="locateUser()">
    <i class="bi bi-geo-alt"></i> My Location
  </button>
  <button class="map-button" onclick="toggleWeatherPanel()">
    <i class="bi bi-info-circle"></i> Weather Info
  </button>
</div>

<!-- Weather Info Panel -->
<div class="weather-info-panel" id="weatherPanel">
  <div class="weather-header">
    <div class="weather-location">Select a location</div>
    <i class="bi bi-x-lg" style="cursor:pointer;" onclick="toggleWeatherPanel()"></i>
  </div>
  <div class="weather-content">
    <div class="weather-temp">--°C</div>
    <div class="weather-desc">
      <img src="" class="weather-icon" id="weatherIcon">
      <span id="weatherDescription">--</span>
    </div>
    <div class="weather-details">
      <div class="detail-item">
        <i class="bi bi-thermometer-half"></i>
        <span>Feels like: <span id="feelsLike">--°C</span></span>
      </div>
      <div class="detail-item">
        <i class="bi bi-droplet"></i>
        <span>Humidity: <span id="humidity">--%</span></span>
      </div>
      <div class="detail-item">
        <i class="bi bi-wind"></i>
        <span>Wind: <span id="windSpeed">-- m/s</span></span>
      </div>
      <div class="detail-item">
        <i class="bi bi-speedometer2"></i>
        <span>Pressure: <span id="pressure">-- hPa</span></span>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // Configuration
  const MAPTILER_API_KEY = '1jqBN8IwXOB8Yj2zIxun';
  const OPENWEATHER_API_KEY = '5c4f49700f913b44be32fc286f7762a9';
  
  // Initialize map with a better starting view
  const map = L.map('map').setView([20, 0], 2);

  // Add MapTiler tile layer with a more detailed style
  L.tileLayer(`https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=${MAPTILER_API_KEY}`, {
    attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">© MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">© OpenStreetMap contributors</a>',
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 19
  }).addTo(map);

  // Weather icons base URL
  const weatherIconUrl = 'https://openweathermap.org/img/wn/{icon}@2x.png';

  // Current popup reference
  let currentPopup = null;
  let currentWeatherData = null;

  // DOM Elements
  const weatherPanel = document.getElementById('weatherPanel');
  const weatherLocation = document.querySelector('.weather-location');
  const weatherTemp = document.querySelector('.weather-temp');
  const weatherIcon = document.getElementById('weatherIcon');
  const weatherDescription = document.getElementById('weatherDescription');
  const feelsLike = document.getElementById('feelsLike');
  const humidity = document.getElementById('humidity');
  const windSpeed = document.getElementById('windSpeed');
  const pressure = document.getElementById('pressure');

  // Toggle weather panel
  function toggleWeatherPanel() {
    weatherPanel.classList.toggle('show');
    if (weatherPanel.classList.contains('show') && currentWeatherData) {
      updateWeatherPanel(currentWeatherData);
    }
  }

  // Update weather panel with data
  function updateWeatherPanel(data) {
    weatherLocation.textContent = data.name || 'Unknown location';
    weatherTemp.textContent = `${Math.round(data.main.temp)}°C`;
    weatherIcon.src = weatherIconUrl.replace('{icon}', data.weather[0].icon);
    weatherIcon.alt = data.weather[0].description;
    weatherDescription.textContent = data.weather[0].description;
    feelsLike.textContent = `${Math.round(data.main.feels_like)}°C`;
    humidity.textContent = `${data.main.humidity}%`;
    windSpeed.textContent = `${data.wind.speed} m/s`;
    pressure.textContent = `${data.main.pressure} hPa`;
  }

  // Function to fetch and display weather data
  async function showWeatherAt(lat, lng) {
    try {
      const response = await fetch(
        `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${OPENWEATHER_API_KEY}&units=metric`
      );
      const data = await response.json();
      
      // Store current weather data
      currentWeatherData = data;
      
      // Update weather panel if visible
      if (weatherPanel.classList.contains('show')) {
        updateWeatherPanel(data);
      }

      // Close previous popup if exists
      if (currentPopup) {
        map.closePopup(currentPopup);
      }

      // Create popup content
      const popupContent = `
        <div style="text-align:center;">
          <h3 style="margin-bottom:8px;">${data.name || 'Unknown location'}</h3>
          <img src="${weatherIconUrl.replace('{icon}', data.weather[0].icon)}" 
               alt="${data.weather[0].description}" 
               style="width:50px;height:50px;margin:0 auto;display:block;">
          <p style="font-size:24px;font-weight:bold;margin:8px 0;">${Math.round(data.main.temp)}°C</p>
          <p style="margin-bottom:4px;">${data.weather[0].description}</p>
          <p style="font-size:12px;margin:2px 0;">Feels like ${Math.round(data.main.feels_like)}°C</p>
        </div>
      `;

      // Create and open popup
      currentPopup = L.popup({ maxWidth: 250, closeButton: false })
        .setLatLng([lat, lng])
        .setContent(popupContent)
        .openOn(map);

      // Auto-close after 8 seconds
      setTimeout(() => {
        if (currentPopup) {
          map.closePopup(currentPopup);
          currentPopup = null;
        }
      }, 8000);

    } catch (error) {
      console.error("Error fetching weather data:", error);
      alert("Couldn't fetch weather data for this location. Please try again.");
    }
  }

  // Click handler for the map
  map.on('click', function(e) {
    showWeatherAt(e.latlng.lat, e.latlng.lng);
  });

  // Function to locate the user
  function locateUser() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          map.flyTo([latitude, longitude], 10);
          showWeatherAt(latitude, longitude);
        },
        (error) => {
          alert("Couldn't get your location: " + error.message);
        }
      );
    } else {
      alert("Geolocation is not supported by your browser");
    }
  }

  // Add a scale control
  L.control.scale({ imperial: false }).addTo(map);
  
  // Add attribution control
  L.control.attribution({
    position: 'bottomleft',
    prefix: false
  }).addTo(map);
  
  // Show weather panel after 3 seconds
  setTimeout(() => {
    weatherPanel.classList.add('show');
  }, 3000);
</script>

</body>
</html>